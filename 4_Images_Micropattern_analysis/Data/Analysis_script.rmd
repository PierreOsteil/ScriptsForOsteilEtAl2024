---
title: "Micorpattern Images analysis"
output: html_document
date: "2023-01-11"
---
```{r}
.vsc.attach() #attach the environment to VSCode
```
```{r}
library(devtools)
install_github("lldelisle/usefulLDfunctions")
library(usefulLDfunctions)

safelyLoadAPackageInCRANorBioconductor("ggplot2")
safelyLoadAPackageInCRANorBioconductor("ggrepel")
safelyLoadAPackageInCRANorBioconductor("dplyr")
safelyLoadAPackageInCRANorBioconductor("ggpubr")
safelyLoadAPackageInCRANorBioconductor("ggrepel")
safelyLoadAPackageInCRANorBioconductor("Rtsne")
safelyLoadAPackageInCRANorBioconductor("plotly")
safelyLoadAPackageInCRANorBioconductor("limma")
safelyLoadAPackageInCRANorBioconductor("HTqPCR")
safelyLoadAPackageInCRANorBioconductor("readr")
safelyLoadAPackageInCRANorBioconductor("tidyverse")
safelyLoadAPackageInCRANorBioconductor("FactoMineR")
safelyLoadAPackageInCRANorBioconductor("repr")
safelyLoadAPackageInCRANorBioconductor("stringr")
safelyLoadAPackageInCRANorBioconductor("devtools")
safelyLoadAPackageInCRANorBioconductor("factoextra")
#heatmap
safelyLoadAPackageInCRANorBioconductor("heatmaply")
safelyLoadAPackageInCRANorBioconductor("pheatmap")
safelyLoadAPackageInCRANorBioconductor("RColorBrewer")
safelyLoadAPackageInCRANorBioconductor("viridis")


```

# get the data
```{r}
file_list <- c(list.files(
    path = "L:/Pierre/Projects/4-All_git/ScriptsForOsteilEtEl2023/4_Images_Micropattern_analysis/Data/Trial10/", pattern = "*.csv", full.names = TRUE),
    list.files(path = "L:/Pierre/Projects/4-All_git/ScriptsForOsteilEtEl2023/4_Images_Micropattern_analysis/Data/Trial20/", pattern = "*.csv", full.names = TRUE)
)

df_microp <- NULL
for (file in file_list) {
  data <- read.csv(file, sep = ",", header = TRUE)
  data$Sample <- rep(file, length(nrow(data)))
  df_microp <- rbind(df_microp, data)
}
head(df_microp)

rm(data, file_list, file) # clean environment

```

# add some metadata

```{r}
df_microp <- df_microp |> mutate(channel = sapply(str_split(df_microp$Label, "c:|z:| "), `[`, 2))
df_microp <- df_microp |> mutate(Z = sapply(str_split(df_microp$Label, "c:|z:| "), `[`, 4))
df_microp <- df_microp |> mutate(Replicate = sapply(str_split(df_microp$Label, "c:|z:| "), `[`, 9))

df_microp <- df_microp |> mutate(CellLine = sapply(str_split(df_microp$Sample, "0/| "), `[`, 2))
df_microp <- df_microp |> mutate(Genotype = sapply(str_split(df_microp$Sample, " |.csv"), `[`, 2))

df_microp <- df_microp |> mutate(Trial = sapply(str_split(df_microp$Sample, "/"), `[`, 8))

head(df_microp)

```


```{r}
toplot <- df_microp |> filter(channel == "1/3") |> filter(!(CellLine  == "MB2")) |> filter(Trial =="Trial20")

# Plot cell density.
Trial10_density<- ggplot(toplot, aes(x = X, y = Y)) +
    geom_hex(stat = "binhex", binwidth = c(50, 50), aes(fill = ..density..)) +
    scale_fill_viridis_c(option = "turbo", trans = "log10") +
    theme_minimal() +
    facet_wrap(CellLine ~ Genotype) +
    coord_fixed()
ggsave("4_Images_Micropattern_analysis/Plots/Trial20_density_plot.pdf", Trial10_density, width = 12, height = 10)

# Create the hexbin-like scatter plot with mean values
FluoPlot <- ggplot(toplot, aes(x = X, y = Y)) +
    geom_hex(binwidth = c(50, 50), aes(fill = ..y..)) +
    facet_wrap(CellLine ~ Genotype)+
    scale_fill_viridis_c(option = "turbo", trans = "log10") +
    stat_summary_hex(
        fun = "mean",
        binwidth = c(50, 50),
        aes(z = Mean),
        show.legend = FALSE
    ) +
  theme_minimal() +
  coord_fixed()

ggsave("4_Images_Micropattern_analysis/Plots/Trial20_SOX17_plot.pdf", FluoPlot, width = 12, height = 10)  
```
